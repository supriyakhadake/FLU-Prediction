# Reading data from excel

library(readxl)
FluDB <- read_excel("C:/Users/Supriya Khadake/Desktop/SPRING 2018/ITMD 529/ITMD529_Project/Data/FluDB.xlsx")
View(FluDB)

## Summary of data
summary(FluDB)

## Structure
str(FluDB)

# Assigning variables

HostIdentifier = FluDB$HostIdentifier
FluDB$Location = as.factor(FluDB$Location)
FluDB$Age = FluDB$Age
FluDB$Gender = as.factor(FluDB$Gender)
FluDB$Temperature = FluDB$Temperature
FluDB$MedicalConditions = as.factor(FluDB$MedicalConditions)
FluDB$RunningNose = as.factor(FluDB$RunningNose)
FluDB$Cough = as.factor(FluDB$Cough)
FluDB$Myalgia = as.factor(FluDB$Myalgia)
FluDB$Headache = as.factor(FluDB$Headache)
FluDB$ThroatAche = as.factor(FluDB$ThroatAche)
FluDB$Fever = as.factor(FluDB$Fever)
FluDB$Fatigue = as.factor(FluDB$Fatigue)
FluDB$Vomiting = as.factor(FluDB$Vomiting)
FluDB$FluTestStatus = as.factor(FluDB$FluTestStatus)

# Splitting data into train(70%) for model selection and test(30%) data for evaluation.

set.seed(42)
FluDB=FluDB[sample(nrow(FluDB)),]
select.data= sample (1:nrow(FluDB), 0.7*nrow(FluDB))
train.data= FluDB[select.data,]
test.data= FluDB[-select.data,]

#To display the number of rows for training and testing data

nrow(test.data)
nrow(train.data)

## Structure of the train data
str(train.data)

## Structure of the test data
str(train.data)

#Statistical description of the dataset

summary(FluDB)

library("rpart", lib.loc="C:/Program Files/R/R-3.3.3/library")
library("rpart.plot", lib.loc="~/R/win-library/3.3")
library("rattle", lib.loc="~/R/win-library/3.3")
library("RGtk2", lib.loc="~/R/win-library/3.3")

##CART -- FLUTestStatus
model1 = rpart(FluTestStatus ~ Age + Temperature + Gender + MedicalConditions + RunningNose + Cough
+ Myalgia + Headache + ThroatAche + Fever + Fatigue + Vomiting, data = train.data, method = "class")
summary(model1)
fancyRpartPlot(model1, cex=.58)

# Make predictions on the testing set -- Model1
my_prediction1 <- predict(model1, test.data, type = "vector")
# Finish the data.frame() call
my_solution1 <- data.frame(ID = test.data$HostIdentifier, flu1 = my_prediction1)
#Generation of Confusion Matrix
conf1 = table(test.data$FluTestStatus, my_solution1$flu1)
conf1
acc1 = sum(diag(conf1))/sum(conf1)
acc1

#RandomForest
library("randomForest", lib.loc="~/R/win-library/3.3")
my_forest_1 <- randomForest(FluTestStatus ~ Age + Temperature + MedicalConditions + RunningNose + Cough
+ Myalgia + Headache + ThroatAche + Fever + Fatigue + Vomiting, train.data, ntree=1000, importance=TRUE)
varImpPlot(my_forest_1)

#Make predictions on the testing set - my_forest_1
my_prediction_1 <- predict(my_forest_1, test.data)
# Make predictions on the testing set -- my_forest_1
my_solution_1 <- data.frame(ID = test.data$HostIdentifier, forest1 = my_prediction_1)
#Generation of Confusion Matrix
conf_1 <- table(test.data$FluTestStatus,my_solution_1$forest1)
conf_1
acc_1 = sum(diag(conf_1))/sum(conf_1)
acc_1

## Logistic Regression Model

#With Location
log0 = glm(FluTestStatus ~ Location + Age + Temperature + Gender + MedicalConditions + RunningNose + Cough
         + Myalgia + Headache + ThroatAche + Fever + Fatigue + Vomiting, data = train.data, family = "binomial")
summary(log0)

#Without Location
log1 = glm(FluTestStatus ~ Age + Temperature + Gender + MedicalConditions + RunningNose + Cough
+ Myalgia + Headache + ThroatAche + Fever + Fatigue + Vomiting, data = train.data, family = "binomial")
summary(log1)

#Without Location & Eliminating Fatigue
log2 = glm(FluTestStatus ~ Age + Temperature + Gender + MedicalConditions + RunningNose + Cough
+ Myalgia + Headache + ThroatAche + Fever + Vomiting, data = train.data, family = "binomial")
summary(log2)

#Without Location & Eliminating ThroatAche
log3 = glm(FluTestStatus ~ Age + Temperature + Gender + MedicalConditions + RunningNose + Cough
+ Myalgia + Headache + Fever + Vomiting, data = train.data, family = "binomial")
summary(log3)

#Without Location & Eliminating Fever
log4 = glm(FluTestStatus ~ Age + Temperature + Gender + MedicalConditions + RunningNose + Cough
+ Myalgia + Headache + Fever + Vomiting, data = train.data, family = "binomial")
summary(log4)

##Step function --Backward Direction for Log0 model
backward0 = step(log0, direction = "backward", trace = F)
summary(backward0)

##Step Function --Forward Direction for Log0 model
base0 = glm (FluTestStatus ~ Age,data = train.data, family = binomial)
forward0 = step(base0, scope =list(upper=log0, lower=~1), direction="forward", trace = F)
summary(forward0)

##Step function --Both direction for Log0 model
both0 = step(base0, scope =list(upper=log0, lower=~1), direction="both", trace = F)
summary(both0)

##Step function --Backward Direction for Log1 model
backward1 = step(log1, direction = "backward", trace = F)
summary(backward1)

##Step Function --Forward Direction for Log1 model
base1 = glm (FluTestStatus ~ Age,data = train.data, family = binomial)
forward1 = step(base1, scope =list(upper=log1, lower=~1), direction="forward", trace = F)
summary(forward1)

##Step function --Both direction for Log1 model
both1 = step(base1, scope =list(upper=log1, lower=~1), direction="both", trace = F)
summary(both1)

#Calculating McFadden's R square value

nullmodel=glm(FluDB$FluTestStatus~1,family="binomial")
1-logLik(log1)/logLik(nullmodel)
1-logLik(log2)/logLik(nullmodel)
1-logLik(log3)/logLik(nullmodel)
1-logLik(log4)/logLik(nullmodel)

#Calculating VIF(checking multicollinearity) for best model i.e. log1
#Load library "car" for the same after installing the package.

library(car)
vif(log1)

##log1 best model --> Interpretating Odds
#FLUTestStatus = -146.46 + 0.08 * Age + 1.43 * Temperature + 0.99 * Gender1 -1.89 * 
#MedicalConditions1 -3.74 * RunningNose1 + 1.96 * Cough1 + 2.85 * Myalgia1 
#- 2.57 * Headache1 – 0.32 * Throatache1 + 0.9 * Fever1 + 26.59 * Fatigue1 + 4.70 * Vomiting1

##substituting values of test data in this equation
#Age = 22, Temperature = 99.2 and Fever = 1
#exp = -2.104

odds = exp(-2.104)/1+exp(-2.104)
odds

##ROC Curve

library("ggplot2", lib.loc="~/R/win-library/3.3")
library("scales", lib.loc="~/R/win-library/3.3")
library("directlabels", lib.loc="~/R/win-library/3.3")
library("tidyr", lib.loc="~/R/win-library/3.3")
library("RColorBrewer", lib.loc="~/R/win-library/3.3")
library("ROCR", lib.loc="~/R/win-library/3.3")

pred <- prediction(my_prediction10, test.data$FluTestStatus)

performance(pred, "auc")

pe <- performance(pred, "tpr", "fpr")
au <- performance(pred, "auc")@y.values[[1]]
pd <- data.frame(fpr=unlist(pe@x.values), tpr=unlist(pe@y.values))
p <- ggplot(pd, aes(x=fpr, y=tpr))
p <- p + geom_line(colour="red")
p <- p + xlab("False Positive Rate") + ylab("True Positive Rate")
p <- p + ggtitle("ROC Curve Decision Tree - Testing FluTestStatus")
p <- p + theme(plot.title=element_text(size=10))
p <- p + geom_line(data=data.frame(), aes(x=c(0,1), y=c(0,1)), colour="grey")
p <- p + annotate("text", x=0.50, y=0.00, hjust=0, vjust=0, size=5,
                  label=paste("AUC =", round(au, 4)))
print(p)

##KNN
train_label = train.data$FluTestStatus
test_label = test.data$FluTestStatus

#Copying train and test to knn_train and knn_test
knn_train <- train.data
knn_test <-test.data

#Dropping FLUTestStatus column for knn_train and knn_test
knn_train$FluTestStatus <- NULL
knn_test$FluTestStatus <- NULL

#Not Considerin location
knn_train$Location <-NULL
knn_test$Location <- NULL

#Normalizing Age
min_age <- min(knn_train$Age)
max_age <- max(knn_train$Age)
knn_train$Age <- (knn_train$Age - min_age) / (max_age - min_age)
knn_test$Age <- (knn_test$Age - min_age) / (max_age - min_age)

#Normalizing Temperature
max_temp <- max(knn_train$Temperature)
min_temp <- min(knn_train$Temperature)
knn_train$Temperature <- (knn_train$Temperature - min_temp) / (max_temp - min_temp)
knn_test$Temperature <- (knn_test$Temperature - min_temp) / (max_temp - min_temp)

#Making Predictionsusing knn: knn_pred with k=3
knn_pred3 = knn(knn_train, knn_test, train_label, k=3, prob= TRUE)
#Constructing confusion matrix 
knn_conf3 <- table(test_label, knn_pred3)
knn_conf3

##Deciding K-value
range = 1:round(0.2* nrow(knn_train))
accs = rep(0, length(range))
for(k in range) {
+ knn_pred = knn(knn_train, knn_test, cl = train_label, k=k)
+ knn_conf <- table(test_label, knn_pred)
+ knn_conf
+ accs[k] = sum(diag(knn_conf))/sum(knn_conf)}
accs[k]
#Plotting the accutacies. Title of x-axis is "k"
plot(range, accs, xlab = "k")
which.max(accs)
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































